<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../lambda2.ico">
  
  <title>Solvers - Laplacians.jl</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  <link href="../Laplacians.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Solvers";
    var mkdocs_page_input_path = "usingSolvers.md";
    var mkdocs_page_url = "/usingSolvers/index.html";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../about/index.html" class="icon icon-home"> Laplacians.jl</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../about/index.html">About</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>User Guide</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Installation/index.html">Installation</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Julia/index.html">Using Julia</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Examples/index.html">Examples</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../CSCgraph/index.html">Sparse matrices as graphs</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../LSST/index.html">Low Stretch Spanning Trees</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="index.html">Solvers</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#solving-linear-equations-in-laplacians">Solving linear equations in Laplacians</a></li>
                
                    <li><a class="toctree-l4" href="#direct-solvers">Direct Solvers</a></li>
                
                    <li><a class="toctree-l4" href="#iterative-solvers">Iterative Solvers</a></li>
                
                    <li><a class="toctree-l4" href="#low-stretch-spanning-trees">Low-Stretch Spanning Trees</a></li>
                
                    <li><a class="toctree-l4" href="#various-linear-system-solvers">Various Linear System Solvers</a></li>
                
            
            </ul>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Developing</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Developing/index.html">Devleoping Laplacians</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>API</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../graphGenerators/index.html">generators</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../operators/index.html">operators</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../graphUtils/index.html">graphUtils</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../graphAlgs/index.html">graphAlgs</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../IO/index.html">IO</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../pcg/index.html">pcg</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../treeAlgs/index.html">treeAlgs</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../akpw/index.html">akpw</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../solvers/index.html">solvers</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../kmp/index.html">KMP</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../localClustering/index.html">localClustering</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../privateFuncs/index.html">Private Functions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../indexOfAll/index.html">All of the above</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../about/index.html">Laplacians.jl</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../about/index.html">Docs</a> &raquo;</li>
    
      
        
          <li>User Guide &raquo;</li>
        
      
    
    <li>Solvers</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/danspielman/Laplacians.jl/edit/master/docs/usingSolvers.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p><a id='Solving-linear-equations-in-Laplacians-1'></a></p>
<h1 id="solving-linear-equations-in-laplacians">Solving linear equations in Laplacians</h1>
<p>For some experiments with solvers, including some of those below, look at the notebook Solvers.ipynb.</p>
<p><a id='Direct-Solvers-1'></a></p>
<h2 id="direct-solvers">Direct Solvers</h2>
<p>You can compute a cholesky factor directly with <code>cholfact</code>.  It does  more than just compute the factor, and it saves its result in a data structure that implements <code>\</code>.  It uses SuiteSparse by Tim Davis.</p>
<p>Here is an example of how you would use it to solve a general non-singular linear system.</p>
<pre><code class="julia">a = grid2(5)
la = lap(a)
la[1,1] = la[1,1] + 1
F = cholfact(la)

n = size(a)[1]
b = randn(n)
x = F \ b
norm(la*x-b)

    1.0598778281116327e-14
</code></pre>

<p>Laplacians, however, are singular.  So, we need to wrap the solver inside a routine that compensates for this.</p>
<pre><code class="julia">la = lap(a)
f = lapWrapSolver(cholfact,la)
b = randn(n); b = b - mean(b);
norm(la*f(b) - b)
    2.0971536951312585e-15
</code></pre>

<p>Here are two other ways of using the wrapper:</p>
<pre><code class="julia">lapChol = lapWrapSolver(cholfact)
f = lapChol(la)
b = randn(n);
b = b - mean(b);
norm(la*f(b) - b)
    2.6924696662484416e-15

x = lapWrapSolver(cholfact,la,b)
norm(la*x - b)
    2.6924696662484416e-15
</code></pre>

<p><a id='Iterative-Solvers-1'></a></p>
<h2 id="iterative-solvers">Iterative Solvers</h2>
<p>The first, of course, is the Conjugate Gradient (cg).</p>
<p>Our implementation requires 2 arguments: the matrix and the right-hand vector.  It's optional arguments are the tolerance <code>tol</code>, the maximum number of iterations, <code>maxits</code>, and the maximum number of seconds, <code>maxtime</code>.  It has been written to use BLAS when possible, and slower routines when dealing with data types that BLAS cannot handle.  For extra information, set <code>verbose</code> to true.  Here are examples.</p>
<pre><code class="julia">srand(1)
n = 50
a = randn(n,n); a = a * a';
b = randn(n)
x = cg(a,b,maxits=100,verbose=true);
    CG stopped after: 66 iterations with relative error 4.901070762774203e-7.
norm(a*x - b)/norm(b)
    4.901071329720876e-7

bbig = convert(Array{BigFloat,1},b)
xbig = cg(a,bbig,maxits=100)
    CG stopped after: 50 iterations with relative error 2.18672511297479336887519117065525148757254642683072581090418060286711737398731e-38.
norm(a*xbig - bbig)
    2.186725112974793368875191170655251487433448469718749360094794057951719231569009e-38
</code></pre>

<p>As a sanity check, we do two speed tests against Matlab.</p>
<pre><code class="julia">la = lap(grid2(200))
n = size(la)[1]
b = randn(n)
b = b - mean(b);
@time x = cg(la,b,maxits=1000)
    0.813791 seconds (2.77 k allocations: 211.550 MB, 3.56% gc time)

norm(la*x-b)
    0.0001900620047823064
</code></pre>

<p>And, in Matlab:</p>
<pre><code class="matlab">&gt;&gt; a = grid2(200);
&gt;&gt; la = lap(a);
&gt;&gt; b = randn(length(a),1); b = b - mean(b);
&gt;&gt; tic; x = pcg(la,b,[],1000); toc
pcg converged at iteration 688 to a solution with relative residual 9.8e-07.
Elapsed time is 1.244917 seconds.
&gt;&gt; norm(la*x-b)

ans =

   1.9730e-04
</code></pre>

<p>PCG also takes as input a preconditioner.  This should be a function.  Here is an example of how one might construct and use a diagonal preonditioner.  To motivate this, I will use a grid with highly varying weights on edges.</p>
<pre><code class="julia">srand(1)
a = mapweight(grid2(200),x-&gt;1/(rand(1)[1]));
la = lap(a)
n = size(la)[1]
b = randn(n)
b = b - mean(b);

d = diag(la)
pre(x) = x ./ d
@time x = pcg(la,b,pre,maxits=2000,verbose=true);

    PCG stopped after: 2000 iterations with relative error 1.535193885968155e-5.
      2.719655 seconds (42.41 k allocations: 1.194 GB, 6.21% gc time)
</code></pre>

<p>If our target is just low error, and we are willing to allow many iterations, here's how cg and pcg compare on this example.</p>
<pre><code class="julia">@time x = pcg(la,b,pre,tol=1e-1,maxits=10^5,verbose=true);
    PCG stopped after: 452 iterations with relative error 0.09944363573171432.
    0.649586 seconds (9.67 k allocations: 277.034 MB, 5.74% gc time) 
norm(la*x - b)/norm(b)
    0.09944363573090279

@time x = cg(la,b,tol=1e-1,maxits=10^5);
    4.526119 seconds (16.03 k allocations: 1.195 GB, 4.16% gc time)

norm(la*x - b)/norm(b)
    0.0981610595725004  
</code></pre>

<p><a id='Low-Stretch-Spanning-Trees-1'></a></p>
<h2 id="low-stretch-spanning-trees">Low-Stretch Spanning Trees</h2>
<p>In order to make preconditioners, we will want low-stretch spanning trees.  We do not yet have any code that is guaranteed to produce these.  Instead, we supply three heuristics: <code>akpw</code> which is inspired by the algorith of Alon, Karp, Peleg and West, and  randomized versions of Prim and Kruskall's algorithm. <code>randishKruskall</code> samples the remaining edges with probability proportional to their weight.  <code>randishPrim</code> samples edges on the boundary while using the same rule.</p>
<p>See <a href="../LSST/index.html">Low Stretch Spanning Trees</a></p>
<p>Let's try using a low-stretch spanning tree as a preconditioner for that last example.  First, we compute a low stretch tree and, for fun, check its average stretch.</p>
<pre><code class="julia">@time tree = akpw(a);
    0.195370 seconds (1.07 M allocations: 86.283 MB, 5.84% gc time)
aveStretch = sum(compStretches(tree,a))/nnz(a)
    6.527424129533183
</code></pre>

<p>To use it as a preconditioner, we must construct a function that inverts linear systems in its Laplacian:</p>
<pre><code class="julia">ltree = lap(tree)
@time ltreeSolver = lapChol(ltree);
    0.045963 seconds (92 allocations: 17.703 MB, 9.51% gc time)
norm(ltree*ltreeSolver(b) - b)
    8.209228285591316e-8
</code></pre>

<p>Now, let's see how well it works as a preconditioner.</p>
<pre><code class="julia">@time x = pcg(la,b,ltreeSolver,tol=1e-1,maxits=10^5,verbose=true);
    PCG stopped after: 153 iterations with relative error 0.09900131423570005.
    0.658006 seconds (12.27 k allocations: 654.998 MB, 11.53% gc time)
</code></pre>

<p>That's a lot like using the diagonal preconditioner.  However, we see that the tree performs fewer iterations, and is faster when we seek higher accuracy.</p>
<pre><code class="julia">@time x = pcg(la,b,pre,tol=1e-6,maxtime=10,verbose=true);
    PCG stopped after: 2435 iterations with relative error 9.92454258869586e-7.
    3.431920 seconds (51.35 k allocations: 1.454 GB, 6.16% gc time)

@time x = pcg(la,b,ltreeSolver,tol=1e-6,maxtime=10,verbose=true);
    PCG stopped after: 605 iterations with relative error 9.78414046170984e-7.
    2.510224 seconds (48.01 k allocations: 2.527 GB, 11.68% gc time)
</code></pre>

<p><a id='Various-Linear-System-Solvers-1'></a></p>
<h2 id="various-linear-system-solvers">Various Linear System Solvers</h2>
<p>We have a blend of solvers geared towards solving symmetric linear systems. Some of these solvers, that have historically showcased good performance, have been grouped into two sections: SDDSolvers and LapSolvers.</p>
<pre><code class="julia">SDDSolvers
5-element Array{Function,1}:
  Laplacians.augTreeSolver    
  Laplacians.KMPSDDSolver     
  Laplacians.hybridSDDSolver  
  Laplacians.samplingSDDSolver
  Laplacians.AMGSolver

LapSolvers
5-element Array{Function,1}:
  Laplacians.augTreeLapSolver 
  Laplacians.KMPLapSolver     
  Laplacians.hybridLapSolver  
  Laplacians.samplingLapSolver
  Laplacians.AMGLapSolver 
</code></pre>

<p>The SDD solvers take in a SDD matrix. They can also take in the usual tol, maxits and maxtime parameters. The Laplacian solvers, in contrast, are fed in an adjacency matrix. They are also subject to tol, maxits and maxtime. Following are examples of how to run these solvers on a given linear system.</p>
<pre><code class="julia">a = mapweight(grid2(100),x-&gt;1/(rand(1)[1]));
n = a.n
la = lap(a); 
dval = zeros(n); dval[1] = dval[n] = 1e-3;
sdd = la + spdiagm(dval);
b = randn(n); b = b - mean(b);
</code></pre>

<p>Now, to run the SDD solvers.</p>
<pre><code class="julia">for solver in SDDSolvers
    println(&quot;Solver &quot;, solver)
    @time f = solver(sdd, maxits=1000, maxtime=10, tol=1e-4, verbose=false)
    @time x = f(b);
    println(&quot;Relative norm: &quot;, norm(sdd * x - b) / norm(b), &quot;\n&quot;)
end

Solver Laplacians.augTreeSolver
  0.067958 seconds (235.22 k allocations: 35.807 MB, 8.41% gc time)
  0.060869 seconds (2.72 k allocations: 70.339 MB, 17.35% gc time)
Relative norm: 9.250884271915595e-5

Solver Laplacians.KMPSDDSolver
  0.063388 seconds (254.46 k allocations: 44.168 MB, 14.65% gc time)
  0.102330 seconds (8.82 k allocations: 133.219 MB, 18.42% gc time)
Relative norm: 9.355785387633888e-5

Solver Laplacians.hybridSDDSolver
  0.064385 seconds (264.54 k allocations: 41.390 MB, 12.33% gc time)
  0.379060 seconds (2.07 M allocations: 266.961 MB, 9.90% gc time)
Relative norm: 9.832304243953024e-5

Solver Laplacians.samplingSDDSolver
  0.135522 seconds (706.74 k allocations: 101.318 MB, 13.69% gc time)
  0.179568 seconds (3.14 M allocations: 144.395 MB, 13.88% gc time)
Relative norm: 9.95716064856691e-5

Solver Laplacians.AMGSolver
  0.030372 seconds (166 allocations: 860.125 KB)
  0.116332 seconds (1.55 k allocations: 4.400 MB)
Relative norm: 9.519986283623698e-5
</code></pre>

<p>Next, the Laplacian solvers.</p>
<pre><code class="julia">for solver in LapSolvers
    println(&quot;Solver &quot;, solver)
    @time f = solver(a, maxits=1000, maxtime=10, tol=1e-4, verbose=false)
    @time x = f(b);
    println(&quot;Relative norm: &quot;, norm(sdd * x - b) / norm(b), &quot;\n&quot;)
end

Solver Laplacians.augTreeLapSolver
  0.072029 seconds (235.32 k allocations: 38.405 MB, 12.87% gc time)
  0.088307 seconds (6.51 k allocations: 98.563 MB, 18.56% gc time)
Relative norm: 0.00015469840172506333

Solver Laplacians.KMPLapSolver
  0.054602 seconds (254.18 k allocations: 39.445 MB, 15.07% gc time)
  0.107957 seconds (8.38 k allocations: 126.549 MB, 21.16% gc time)
Relative norm: 0.0001558714652838137

Solver Laplacians.hybridLapSolver
  0.053575 seconds (267.23 k allocations: 36.942 MB, 6.97% gc time)
  0.407590 seconds (3.02 M allocations: 286.329 MB, 10.58% gc time)
Relative norm: 0.00015420023270231535

Solver Laplacians.samplingLapSolver
  0.119625 seconds (706.35 k allocations: 90.641 MB, 21.37% gc time)
  0.218231 seconds (3.52 M allocations: 161.625 MB, 14.20% gc time)
Relative norm: 0.00015470313398451233

Solver Laplacians.AMGLapSolver
  0.043749 seconds (235 allocations: 2.744 MB)
  0.179676 seconds (1.57 k allocations: 4.402 MB)
Relative norm: 0.00014173955766018617
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Developing/index.html" class="btn btn-neutral float-right" title="Devleoping Laplacians">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../LSST/index.html" class="btn btn-neutral" title="Low Stretch Spanning Trees"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/danspielman/Laplacians.jl" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../LSST/index.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../Developing/index.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../js/theme.js"></script>
      <script src="../assets/mathjaxhelper.js"></script>

</body>
</html>
